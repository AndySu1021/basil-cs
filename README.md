# ğŸŒ¿ BasilCS å®¢æœç³»çµ±

Digital Ocean æŠ˜æ‰£ç¢¼é€£çµ  
https://m.do.co/c/5cea3707b649

é–‹ç®±å³ç”¨ï¼Œæ¶æ§‹ä¸Šé¸æ“‡å‰å¾Œç«¯åˆ†é›¢ï¼Œä¾¿æ–¼åœ˜éšŠäºŒæ¬¡é–‹ç™¼  
ä¸»è¦æŠ€è¡“æ£§ç‚º Golang + Vue + MySQL + Redis  
æ•´å¥—ç³»çµ±ç¸½å…±åˆ†ç‚ºä¸‰å€‹å­ç³»çµ±ï¼š
- cs-api å®¢æœç³»çµ±æœå‹™ç«¯
- cs-web-cms å®¢æœå¾Œå°ç®¡ç†ç³»çµ±
- cs-web-chat å®¢æœå®¢æˆ¶ç«¯è«®è©¢é é¢

## é …ç›®ç‰¹é»
- åŸºæ–¼ uber fx DI æ¡†æ¶é–‹ç™¼
- åŸºæ–¼ cobra é–‹ç™¼ CLI äº’å‹•ä»‹é¢
- åŸºæ–¼ viper ç®¡ç†é…ç½®åƒæ•¸
- åŸºæ–¼ websocket çš„èŠå¤©é€šä¿¡
- å¾Œç«¯æ”¯æ´å‹•æ…‹æ“´å®¹
- æ•¸æ“šåº«äº¤äº’æ–¹é¢é€é sqlc ç·¨è­¯ï¼Œå–®å…ƒæ¸¬è©¦æ™‚ä¾¿æ–¼æ›¿æ›è‡ªå®šç¾© mock æ–¹æ³•
- å¾Œç«¯é–‹ç™¼æ¶æ§‹ä¸Šæ ¹æ“šæ¥­å‹™æ¨¡çµ„åšæ‹†åˆ†ï¼Œå¦‚ï¼š./cs-api/pkg/module

## åŠŸèƒ½åˆ—è¡¨
- å®¢æœè«®è©¢é¢æ¿
- è·å“¡ç®¡ç†
- æ¬Šé™ç®¡ç†
- æœƒå“¡ç®¡ç†
- å¤šç«™é»ç®¡ç†
- å¸¸è¦‹å•é¡Œç®¡ç†
- å¿«æ·å›è¦†ç®¡ç†
- è«®è©¢æˆ¿æ¨™ç±¤ç®¡ç†
- å ±è¡¨ç®¡ç†
- æ­·å²ç´€éŒ„æŸ¥è©¢
- å¾Œå°æé†’ç®¡ç†
- ç³»çµ±å…¬å‘Šç®¡ç†

## å¦‚ä½•ä½¿ç”¨
### æ¥å…¥å®¢æˆ¶ç«¯æµç¨‹åœ–
```mermaid
sequenceDiagram
å®¢æœå¾Œå°->>æœå‹™ç«¯: å‰µå»ºç«™é»
æ‚¨çš„ç¶²ç«™->>æœå‹™ç«¯: å‰µå»ºè«®è©¢æˆ¿
æœå‹™ç«¯->>æ‚¨çš„ç¶²ç«™: å®¢æˆ¶ç«¯é€£çµ
å®¢æˆ¶ç«¯-->>æ‚¨çš„ç¶²ç«™: åµŒå…¥
æ‚¨çš„ç¶²ç«™->>æœå‹™ç«¯: é–‹å§‹è«®è©¢
å®¢æœå¾Œå°->>æœå‹™ç«¯: å›æ‡‰è«®è©¢
```

### æœ¬åœ°éƒ¨ç½²
ç‚ºäº†æ–¹ä¾¿å¿«é€Ÿå•Ÿå‹•ï¼Œå¯ä»¥åƒè€ƒ ./docker ç›®éŒ„ï¼Œæä¾›è©²é …ç›®æœƒä½¿ç”¨åˆ°çš„å·¥å…·ï¼Œå¯å†ä¾æ“šéœ€æ±‚è‡ªè¡Œæ“´å……ã€‚

#### ç¯„ä¾‹æ­¥é©Ÿï¼š
1. åŸŸåæ·»åŠ 
```shell
# é€²å…¥ hosts æª”æ¡ˆ
sudo vim /etc/hosts
# æ·»åŠ ä»¥ä¸‹åŸŸå
127.0.0.1 chat.local.cs.com cms.local.cs.com static.local.cs.com
```
2. ç·¨è­¯å‰ç«¯  
- å®¢æœå¾Œå° (cs-web-cms)
```shell
# åˆ‡æ›ç›®éŒ„
cd cs-web-cms
# æ–°å¢ .env æª”æ¡ˆ
cp .env.example .env
# å®‰è£ä¾è³´
yarn
# ç·¨è­¯
yarn build
```
- å®¢æœå®¢æˆ¶ç«¯ (cs-web-chat)
```shell
# åˆ‡æ›ç›®éŒ„
cd cs-web-chat
# æ–°å¢ .env æª”æ¡ˆ
cp .env.example .env
# å®‰è£ä¾è³´
yarn
# ç·¨è­¯
yarn build
```
2. å•Ÿå‹•å®¹å™¨
```shell
# åˆ‡æ›åˆ° docker ç›®éŒ„ä¸‹é¢
cd docker
# å•Ÿå‹•å®¹å™¨
docker-compose up -d
```
3. å•Ÿå‹•å®¢æœæœå‹™ç«¯ (cs-api)
```shell
# åˆ‡æ›ç›®éŒ„
cd cs-api
# å•Ÿå‹• server é è¨­ port 8082
make server
```
å®Œæˆä»¥ä¸Šæ­¥é©Ÿå°±å¯ä»¥é–‹å•Ÿ http://cms.local.cs.com æŸ¥çœ‹ç•«é¢äº†  
ç™»å…¥å¸³è™Ÿå’Œå¯†ç¢¼éƒ½æ˜¯ adminï¼Œå¯†ç¢¼èƒ½å¤ åœ¨ ./cs-api/config/config.yaml#admin_password ä¸­è‡ªè¡Œè¨­å®š

4. é–‹èµ·å®¢æˆ¶ç«¯èŠå¤©é é¢  
   1. éœ€è¦å…ˆè‡³å®¢æœå¾Œå° [ç«™é»ç®¡ç†] ä¸­æ–°å¢ä¸€å€‹ç«™é»
   2. å‘¼å« POST http://localhost:8082/room å‰µå»ºè«®è©¢æˆ¿ï¼Œç²å–å®¢æˆ¶ç«¯é€£çµï¼Œå³å¯è¨ªå•ã€‚è«‹æ±‚åƒæ•¸ç¯„ä¾‹å¦‚ä¸‹ï¼š
```json
{
    "code": "test",
    "source": 1,
    "name": "andy"
}
```
### å®¹å™¨åŒ–éƒ¨ç½²
åœ¨å„å€‹å­ç³»çµ±ä¸‹æä¾› dockerfile ä»¥åŠ ./deploy ç›®éŒ„ä¾›æ‚¨åƒè€ƒä½¿ç”¨ï¼Œä¾¿æ–¼å¿«é€Ÿé€²è¡Œå®¹å™¨åŒ–éƒ¨ç½²è‡³ kubernetes æˆ–è€…æ˜¯ serverless æ‡‰ç”¨ä¸­ï¼Œä¾‹å¦‚ GCP Cloud Run

## å¸¸è¦‹å•é¡Œ
| å•é¡Œ            | ç­”æ¡ˆ                                                                     |
|---------------|------------------------------------------------------------------------|
| websocket é€£ä¸ä¸Š | æª¢æŸ¥æ˜¯å¦æ²’æœ‰å°‡ Origin æ·»åŠ é€²ç™½åå–® ./cs-api/config/config.yaml#ws_origin_white_list |